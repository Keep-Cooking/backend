name: Deploy API on push to main

on:
  push:
    branches: [main]

concurrency:
  group: deploy-api-on-main
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Check out main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Mark repo as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Build & (re)start API with Docker Compose
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          THEMEALDB_API_KEY: ${{ secrets.THEMEALDB_API_KEY }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          echo ${GOOGLE_API_KEY} && docker compose -f compose.yml -f compose.prod.yml up -d --build --pull always api
